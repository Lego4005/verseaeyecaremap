<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta charset='utf-8' />
    <title>Versea EyeCare</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body { 
        margin: 0; 
        padding: 0; 
      }
      #map { 
        position: absolute; 
        top: 0; 
        bottom: 0; 
        width: 100%; 
      }
    </style>
  </head>
  <body>
    <div id='map'></div>
    <div style="position: absolute; z-index: 1; padding: 10px;">
      <div style="display: flex; flex-direction: column;">
        <label style="display: flex; align-items: center;">
          <input type="checkbox" class="equity-toggle" value="AEG" checked>
          <span>AEG</span>
          <span style="margin-left: auto;">Total: <span id="total-AEG">0</span></span>
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" class="equity-toggle" value="ECP" checked>
          <span>ECP</span>
          <span style="margin-left: auto;">Total: <span id="total-ECP">0</span></span>
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" class="equity-toggle" value="ESP" checked>
          <span>ESP</span>
          <span style="margin-left: auto;">Total: <span id="total-ESP">0</span></span>
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" class="equity-toggle" value="BCP" checked>
          <span>BCP</span>
          <span style="margin-left: auto;">Total: <span id="total-BCP">0</span></span>
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" class="equity-toggle" value="ECSP" checked>
          <span>ECSP</span>
          <span style="margin-left: auto;">Total: <span id="total-ECSP">0</span></span>
        </label>
        <label style="display: flex; align-items: center;">
          <input type="checkbox" class="equity-toggle" value="WPO" checked>
          <span>WPO</span>
          <span style="margin-left: auto;">Total: <span id="total-WPO">0</span></span>
        </label>
      </div>
    </div>
    
    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY29sYnlmb3giLCJhIjoiY2xlNmJhMWxyMGE5YjNvcW02dWFtbzhpeSJ9.EpanROBym2vRINMDfmysig'; 
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/colbyfox/cle6m689j000301mjf1w0jfip', 
      center: [0, 0],
      zoom: 1
    });

    // Fly to the United States when the map is first loaded
    map.flyTo({ center: [-95, 37], zoom: 4.2, duration: 10000 });

    function setEquityGroupVisibility(equityGroup, isVisible) {
      const visibility = isVisible ? 'visible' : 'none';
      map.setLayoutProperty(`symbols-${equityGroup}`, 'visibility', visibility);
    }

    // Add event listeners for checkboxes
    document.querySelectorAll('.equity-toggle').forEach((checkbox) => {
      checkbox.addEventListener('change', (event) => {
        setEquityGroupVisibility(event.target.value, event.target.checked);
        updateEquityGroupTotals();
      });
    });

    function updateEquityGroupTotals() {
  const equityGroups = ["AEG", "ECP", "ESP", "BCP", "ECSP", "WPO"];
  const equityGroupCounts = {};

  // Initialize counts
  equityGroups.forEach(group => {
    equityGroupCounts[group] = 0;
  });

  // Count occurrences of each equity group in the features
  const features = map.queryRenderedFeatures({ layers: ["symbols"] });
  features.forEach(feature => {
    const equityGroup = feature.properties["Equity Group"];
    if (equityGroupCounts.hasOwnProperty(equityGroup)) {
      equityGroupCounts[equityGroup]++;
    }
  });

  // Update the totals on the HTML elements
  equityGroups.forEach(group => {
    document.getElementById(`total-${group}`).innerText = equityGroupCounts[group];
  });
}


    map.on('load', () => {
      // Get the existing symbol layer from the style
      const symbolsLayer = map.getStyle().layers.find(layer => layer.id === 'symbols');
      
      const equityGroups = ['AEG', 'ECP', 'ESP', 'BCP', 'ECSP', 'WPO'];

      equityGroups.forEach(equityGroup => {
        // Duplicate the symbol layer and apply a filter for each Equity Group
        const newLayer = {
          ...symbolsLayer,
          id: `symbols-${equityGroup}`,
          filter: ['==', ['get', 'Equity Group'], equityGroup]
        };

        // Remove the original layer and add the new filtered layers
        map.removeLayer('symbols');
        map.addLayer(newLayer);
      });
      updateEquityGroupTotals();
    });
    </script>
  </body>
</html>
